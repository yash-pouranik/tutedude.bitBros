<% layout("layouts/boilerplate") %>

<% user.notifications.forEach(notif => { %>
  <% if (notif.type === 'deliveryReview') { %>
    <div class="alert alert-info d-flex justify-content-between align-items-center">
      <span><%= notif.message %></span>
      <button 
        class="btn btn-sm btn-outline-primary review-btn"
        data-supplier-id="<%= notif.supplierId %>"
        data-bs-toggle="modal"
        data-bs-target="#reviewModal">
        Give Review
      </button>
    </div>
  <% } else { %>
    <p><a href="<%= notif.link %>"><%= notif.message %></a></p>
  <% } %>
<% }) %>



<div class="container py-5">
  <div class="text-center mb-5">
    <h1 class="welcome-heading">
      👋 Welcome, <span><%= currUser?.username || "User" %></span>!
    </h1>
    <p class="text-muted">Here’s a quick overview of your profile and options.</p>
  </div>

  <% if (currUser) { %>
    <!-- Profile Card -->
    <div class="card profile-card shadow mb-5">
      <div class="card-header text-white bg-gradient-primary">
        <h5 class="mb-0"><i class="bi bi-person-circle me-2"></i>Your Profile</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <p><strong>📞 Phone:</strong> <%= currUser.phone || "N/A" %></p>
            <p><strong>👤 User Type:</strong> <%= currUser.userType || "N/A" %></p>
          </div>
          <div class="col-md-6">
            <p><strong>📍 Address:</strong><br>
              <%= currUser.address?.street || "" %>
              <%= currUser.address?.city || "" %>
              <%= currUser.address?.state || "" %>
              <%= currUser.address?.pincode || "" %>
              <% if (currUser.userType === "supplier") { %>
                <p><strong>💰 Total Earnings:</strong> ₹<%= currUser.totalEarnings || 0 %></p>
              <% } %>

            </p>
            <p><strong>🗓️ Registered:</strong> <%= currUser.createdAt ? currUser.createdAt.toDateString() : "N/A" %></p>
          </div>
        </div>
        <div class="text-end mt-3">
          <a href="/profile/edit/<%= currUser._id %>" class="btn btn-outline-danger btn-sm">Edit Profile</a>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row g-4">
      <% if (currUser.userType === 'supplier') { %>
        <div class="col-md-4">
          <a href="/supplier/add-product" class="btn dashboard-btn bg-success text-white w-100">
            ➕ Add New Product
          </a>
        </div>
        <div class="col-md-4">
          <a href="/supplier/manage-products/<%= currUser._id %>" class="btn dashboard-btn bg-primary text-white w-100">
            🛒 Manage Products
          </a>
        </div>
        <div class="col-md-4">
          <a href="/supplier/orders" class="btn dashboard-btn bg-dark text-white w-100">
            📦 View Requests
          </a>
        </div>
      <% } %>

      <% if (currUser.userType === 'vendor') { %>
        <div class="col-md-6 offset-md-3">
          <a href="/vendor/orders" class="btn dashboard-btn bg-info text-white w-100">
            🧾 Order History
          </a>
        </div>
      <% } %>
    </div>
  <% } else { %>
    <div class="alert alert-warning text-center mt-4">
      Please <a href="/login" class="alert-link">log in</a> to view your dashboard.
    </div>
  <% } %>

  <!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form action="/submit-review" method="POST">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reviewModalLabel">Rate Your Supplier</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="supplierId" id="supplierIdInput">
          <div class="mb-3">
            <label class="form-label">Quality of Product</label>
            <select class="form-select" name="qualityRating" required>
              <option value="" disabled selected>Select Rating</option>
              <option value="1">1 - Poor</option>
              <option value="2">2</option>
              <option value="3">3 - Average</option>
              <option value="4">4</option>
              <option value="5">5 - Excellent</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Delivery Timing</label>
            <select class="form-select" name="deliveryRating" required>
              <option value="" disabled selected>Select Rating</option>
              <option value="1">1 - Very Late</option>
              <option value="2">2</option>
              <option value="3">3 - On Time</option>
              <option value="4">4</option>
              <option value="5">5 - Early</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Experience with Supplier</label>
            <select class="form-select" name="experienceRating" required>
              <option value="" disabled selected>Select Rating</option>
              <option value="1">1 - Bad</option>
              <option value="2">2</option>
              <option value="3">3 - Okay</option>
              <option value="4">4</option>
              <option value="5">5 - Great</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Additional Comments (Optional)</label>
            <textarea class="form-control" name="comment" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Submit Review</button>
        </div>
      </div>
    </form>
  </div>
</div>


</div>

<script>
  document.querySelectorAll('.review-btn').forEach(button => {
    button.addEventListener('click', () => {
      const supplierId = button.getAttribute('data-supplier-id');
      document.getElementById('supplierIdInput').value = supplierId;
    });
  });
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".review-btn").forEach((btn) => {
      btn.addEventListener("click", function () {
        const supplierId = this.getAttribute("data-supplier-id");
        document.getElementById("supplierIdInput").value = supplierId;
      });
    });
  });
</script>






